caption: WireGuard - ArchWiki
created: 20230118012232362
location: https://wiki.archlinux.org/title/WireGuard
modified: 20230118012531328
title: WireGuard - ArchWiki
type: text/vnd.tiddlywiki
when: 2023/1/17 19:22:32

https://wiki.archlinux.org/title/WireGuard


							

				<div data-mw-ve-target-container="" class="vector-body" id="bodyContent">
					<div class="mw-body-subheader">
					        <div class="mw-indicators">
        </div>

					    <div class="noprint" id="siteSub">From ArchWiki</div>
					</div>
					
					
					
					<div dir="ltr" lang="en" class="mw-body-content mw-content-ltr" id="mw-content-text"><div class="mw-parser-output"><div class="archwiki-template-meta-related-articles-start"><p class="mw-no-invert">Related articles</p><ul>
<li><a title="Linux Containers/Using VPNs" href="https://wiki.archlinux.org/title/WireGuard/title/Linux_Containers/Using_VPNs">Linux Containers/Using VPNs</a></li>
</ul></div>
<p>From the <a href="https://www.wireguard.com/" class="external text" rel="nofollow">WireGuard</a> project homepage:
</p>
<dl><dd>WireGuard is an extremely simple yet fast and modern VPN that utilizes state-of-the-art cryptography. It aims to be faster, simpler, leaner, and more useful than IPsec, while avoiding the massive headache. It intends to be considerably more performant than OpenVPN. WireGuard is designed as a general purpose VPN for running on embedded interfaces and super computers alike, fit for many different circumstances. Initially released for the Linux kernel, it is now cross-platform (Windows, macOS, BSD, iOS, Android) and widely deployable.</dd></dl>
<p>A rough introduction to the main concepts used in this article can be found on <a href="https://www.wireguard.com/" class="external text" rel="nofollow">WireGuard's</a> project homepage. WireGuard has been included in the <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e7096c131e5161fa3b8e52a650d7719d2857adfd" class="external text" rel="nofollow">Linux kernel</a> since late 2019.
</p>

<h2><span id="Installation" class="mw-headline">Installation</span></h2>
<p><a title="Install" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Install">Install</a> the <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=wireguard-tools" class="external text" rel="nofollow">wireguard-tools</a></span> package for userspace utilities.
</p><p>Alternatively, various network managers provide support for WireGuard, provided that peer keys are available. See <a href="https://wiki.archlinux.org/title/WireGuard#Persistent_configuration">#Persistent configuration</a> for details.
</p>
<h3><span id="Graphical_clients" class="mw-headline">Graphical clients</span></h3>
<ul><li><b>Qomui</b> — OpenVPN GUI with advanced features and support for multiple providers.</li></ul>
<dl><dd><a href="https://github.com/corrad1nho/qomui" class="external free" rel="nofollow">https://github.com/corrad1nho/qomui</a> || <span class="plainlinks archwiki-template-pkg"><a href="https://aur.archlinux.org/packages/qomui/" class="external text" rel="nofollow">qomui</a></span><sup><small>AUR</small></sup></dd></dl>
<h3><span id="Command-line_tools" class="mw-headline">Command-line tools</span></h3>
<ul><li><b>wg_tool</b> — Tool to manage wireguard configs for server and users.</li></ul>
<dl><dd><a href="https://github.com/gene-git/wg_tool" class="external free" rel="nofollow">https://github.com/gene-git/wg_tool</a> || <span class="plainlinks archwiki-template-pkg"><a href="https://aur.archlinux.org/packages/wg_tool/" class="external text" rel="nofollow">wg_tool</a></span><sup><small>AUR</small></sup></dd></dl>
<h2><span id="Usage" class="mw-headline">Usage</span></h2>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-edit-clear.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/8/87/Tango-edit-clear.png" alt="Tango-edit-clear.png"></a><b>This article or section needs language, wiki syntax or style improvements. See <a title="Help:Style" href="https://wiki.archlinux.org/title/WireGuard/title/Help:Style">Help:Style</a> for reference.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-edit-clear.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/8/87/Tango-edit-clear.png" alt="Tango-edit-clear.png"></a></p>
<div><b>Reason:</b> Useless section name – everything on this page is about WireGuard usage. Moving the 4 subsections to the top level would make sense. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<p>The commands below demonstrate how to set up a basic tunnel between two or more peers with the following settings:
</p>
<table class="wikitable">
<tbody><tr>
<th rowspan="2">
</th>
<th colspan="3">External (public) addresses
</th>
<th colspan="2">Internal IP addresses
</th>
<th rowspan="2">Port
</th></tr>
<tr>
<th>Domain name
</th>
<th>IPv4 address
</th>
<th>IPv6 address
</th>
<th>IPv4 address
</th>
<th>IPv6 address
</th></tr>
<tr>
<th>Peer A
</th>
<td>
</td>
<td>198.51.100.101
</td>
<td>2001:db8:a85b:70a:ffd4:ec1b:4650:a001
</td>
<td>10.0.0.1/24
</td>
<td>fdc9:281f:04d7:9ee9::1/64
</td>
<td>UDP/51871
</td></tr>
<tr>
<th>Peer B
</th>
<td>peer-b.example
</td>
<td>203.0.113.102
</td>
<td>2001:db8:40f0:147a:80ad:3e88:f8e9:b002
</td>
<td>10.0.0.2/24
</td>
<td>fdc9:281f:04d7:9ee9::2/64
</td>
<td>UDP/51902
</td></tr>
<tr>
<th>Peer C
</th>
<td>
</td>
<td><i>dynamic</i>
</td>
<td><i>dynamic</i>
</td>
<td>10.0.0.3/24
</td>
<td>fdc9:281f:04d7:9ee9::3/64
</td>
<td>UDP/51993
</td></tr></tbody></table>
<div class="archwiki-template-box archwiki-template-box-tip"><strong>Tip:</strong> The same UDP port can be used for all peers.</div>
<p>The external addresses should already exist. For example, if ICMP echo requests are not blocked, peer A should be able to <a title="Ping" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Ping">ping</a> peer B via its public IP address(es) and vice versa.
</p><p>The internal addresses will be new addresses, created either manually using the <span title="$ man 8 ip" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/ip.8" class="external text" rel="nofollow">ip(8)</a></span> utility or by network management software, which will be used internally within the new WireGuard network. The following examples will use 10.0.0.0/24 and fdc9:281f:04d7:9ee9::/64 as the internal network. The <code>/24</code> and <code>/64</code> in the IP addresses is the <a title="wikipedia:Classless Inter-Domain Routing" class="extiw" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#CIDR_notation">CIDR</a>.
</p>
<h3><span id="Key_generation" class="mw-headline">Key generation</span></h3>
<p>Create a private and public key for each peer. If connecting dozens of peers optionally consider a vanity keypair to personalize the Base64 encoded public key string. See <a href="https://wiki.archlinux.org/title/WireGuard#Vanity_keys">#Vanity keys</a>.
</p><p>To create a private key run:
</p>
<pre>$ (umask 0077; wg genkey &gt; peer_A.key)
</pre>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> It is recommended to only allow reading and writing access for the owner. The above alters the <a title="Umask" href="https://wiki.archlinux.org/title/WireGuard/title/Umask">umask</a> temporarily within a sub-shell to ensure that access (read/write permissions) is restricted to the owner.</div>
<p>To create a public key:
</p>
<pre>$ wg pubkey &lt; peer_A.key &gt; peer_A.pub
</pre>
<p>Alternatively, do this all at once:
</p>
<pre>$ wg genkey | (umask 0077 &amp;&amp; tee peer_A.key) | wg pubkey &gt; peer_A.pub
</pre>
<p>One can also generate a pre-shared key to add an additional layer of symmetric-key cryptography to be mixed into the already existing public-key cryptography, for post-quantum resistance. A pre-shared key should be generated for each peer pair and should not be reused. For example, three interconnected peers, A, B, and, C will need three separate pre-shared keys, one for each peer pair.
</p><p>Generate a pre-shared key for each peer pair using the following command (make sure to use <code>umask 0077</code> for this as well):
</p>
<pre>$ wg genpsk &gt; peer_A-peer_B.psk
$ wg genpsk &gt; peer_A-peer_C.psk
$ wg genpsk &gt; peer_B-peer_C.psk
</pre>
<h4><span id="Vanity_keys" class="mw-headline">Vanity keys</span></h4>
<p>Currently, WireGuard does not support comments or attaching human-memorable names to keys.  This makes identifying the key's owner difficult particularly when multiple keys are in use.  One solution is to generate a public key that contains some familiar characters (perhaps the first few letters of the owner's name or of the hostname etc.), <span class="plainlinks archwiki-template-pkg"><a href="https://aur.archlinux.org/packages/wireguard-vanity-address/" class="external text" rel="nofollow">wireguard-vanity-address</a></span><sup><small>AUR</small></sup> does this.
</p><p>For example:
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">$ wireguard-vanity-address --in 8 leslie</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">searching for 'leslie' in pubkey[0..10], one of every 214748364 keys should match
one core runs at 2.69e6 keys/s, CPU cores available: 16
est yield: 5.0 seconds per key, 200.10e-3 keys/s
hit Ctrl-C to stop
private wEoVMj92P+E3fQXVf9IixWJqpCqcnP/4OfvrB1g3zmY=  public LEsliEny+aMcWcRbh8Qf414XsQHSBOAFk3TaEk/aSD0=
private EAOwlGGqpHVbZ9ehaCspdBJt+lkMcCfkwiA5T5a4JFs=  public VlesLiEB5BFd//OD2ILKXviolfz+hodG6uZ+XjoalC8=
private UDWG4VWI+RzAGzNSnlC+0X4d3nk9goWPs/NRC5tX524=  public 9lESlieIFOlJFV6dG7Omao2WS+amWgshDdBYn8ahRjo=</pre>
<h3><span id="Manual_configuration" class="mw-headline">Manual configuration</span></h3>
<h4><span id="Peer_setup" class="mw-headline">Peer setup</span></h4>
<p>Manual setup is accomplished by using <span title="$ man 8 ip" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/ip.8" class="external text" rel="nofollow">ip(8)</a></span> and <span title="$ man 8 wg" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg.8" class="external text" rel="nofollow">wg(8)</a></span>.
</p>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-edit-clear.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/8/87/Tango-edit-clear.png" alt="Tango-edit-clear.png"></a><b>This article or section needs language, wiki syntax or style improvements. See <a title="Help:Style" href="https://wiki.archlinux.org/title/WireGuard/title/Help:Style">Help:Style</a> for reference.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-edit-clear.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/8/87/Tango-edit-clear.png" alt="Tango-edit-clear.png"></a></p>
<div><b>Reason:</b> These examples use the pre-shared keys which were introduced as <i>optional</i> in <a href="https://wiki.archlinux.org/title/WireGuard#Key_generation">#Key generation</a>. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<p><b>Peer A setup:</b>
</p><p>In this example peer A will listen on UDP port 51871 and will accept connection from peer B and C.
</p>
<pre># ip link add dev wg0 type wireguard
# ip addr add 10.0.0.1/24 dev wg0
# ip addr add fdc9:281f:04d7:9ee9::1/64 dev wg0
# wg set wg0 listen-port 51871 private-key <i>/path/to/</i>peer_A.key
# wg set wg0 peer <i>PEER_B_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_A-peer_B.psk endpoint peer-b.example:51902 allowed-ips 10.0.0.2/32,fdc9:281f:04d7:9ee9::2/128
# wg set wg0 peer <i>PEER_C_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_A-peer_C.psk allowed-ips 10.0.0.3/32,fdc9:281f:04d7:9ee9::3/128
# ip link set wg0 up
</pre>
<p><code><i>PEER_X_PUBLIC_KEY</i></code> should be the contents of <code><i>peer_X</i>.pub</code>.
</p><p>The keyword <code>allowed-ips</code> is a list of addresses that will get routed to the peer. Make sure to specify at least one address range that contains the WireGuard connection's internal IP address(es).
</p><p><b>Peer B setup:</b>
</p>
<pre># ip link add dev wg0 type wireguard
# ip addr add 10.0.0.2/24 dev wg0
# ip addr add fdc9:281f:04d7:9ee9::2/64 dev wg0
# wg set wg0 listen-port 51902 private-key <i>/path/to/</i>peer_B.key
# wg set wg0 peer <i>PEER_A_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_A-peer_B.psk endpoint 198.51.100.101:51871 allowed-ips 10.0.0.1/32,fdc9:281f:04d7:9ee9::1/128
# wg set wg0 peer <i>PEER_C_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_B-peer_C.psk allowed-ips 10.0.0.3/32,fdc9:281f:04d7:9ee9::3/128
# ip link set wg0 up
</pre>
<p><b>Peer C setup:</b>
</p>
<pre># ip link add dev wg0 type wireguard
# ip addr add 10.0.0.3/24 dev wg0
# ip addr add fdc9:281f:04d7:9ee9::3/64 dev wg0
# wg set wg0 listen-port 51993 private-key <i>/path/to/</i>peer_C.key
# wg set wg0 peer <i>PEER_A_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_A-peer_C.psk endpoint 198.51.100.101:51871 allowed-ips 10.0.0.1/32,fdc9:281f:04d7:9ee9::1/128
# wg set wg0 peer <i>PEER_B_PUBLIC_KEY</i> preshared-key <i>/path/to/</i>peer_B-peer_C.psk endpoint peer-b.example:51902 allowed-ips 10.0.0.2/32,fdc9:281f:04d7:9ee9::2/128
# ip link set wg0 up
</pre>
<h4><span id="Additional_routes" class="mw-headline">Additional routes</span></h4>
<p>To establish connections more complicated than point-to-point, additional setup is necessary.
</p>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-view-fullscreen.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/3/38/Tango-view-fullscreen.png" alt="Tango-view-fullscreen.png"></a><b>This article or section needs expansion.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-view-fullscreen.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/3/38/Tango-view-fullscreen.png" alt="Tango-view-fullscreen.png"></a></p>
<div><b>Reason:</b> Add a scenario: only peer A has a public IP address (i.e. <i>endpoint</i>), peers B and C (which are generally behind a NAT) connect to peer A with <code>PersistentKeepalive</code>, connections from peer B to peer C and vice versa are routed via peer A. Configuration: peers B and C have <code>10.0.0.0/24</code> in <code>AllowedIPs</code> for peer A, peer A must enable packet forwarding and masquerading via firewall rules, e.g. <code>iptables -A FORWARD -i wg+ -j ACCEPT</code> and <code>iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -o wg0 -j MASQUERADE</code>. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<h5><span id="Point-to-site" class="mw-headline">Point-to-site</span></h5>
<p>To access the network of a peer, specify the network subnet(s) in <code>allowed-ips</code> in the configuration of the peers who should be able to connect to it. E.g. <code>allowed-ips 10.0.0.2/32,fdc9:281f:04d7:9ee9::2/128,<b>192.168.35.0/24,fd7b:d0bd:7a6e::/64</b></code>.
</p><p>Make sure to also set up the <a title="Network configuration" href="https://wiki.archlinux.org/title/WireGuard/title/Network_configuration#Routing_table">routing table</a> with <span title="$ man 8 ip-route" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/ip-route.8" class="external text" rel="nofollow">ip-route(8)</a></span>. E.g.:
</p>
<pre># ip route add 192.168.35.0/24 dev wg0
# ip route add fd7b:d0bd:7a6e::/64 dev wg0
</pre>
<h5><span id="Site-to-point" class="mw-headline">Site-to-point</span></h5>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-view-fullscreen.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/3/38/Tango-view-fullscreen.png" alt="Tango-view-fullscreen.png"></a><b>This article or section needs expansion.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-view-fullscreen.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/3/38/Tango-view-fullscreen.png" alt="Tango-view-fullscreen.png"></a></p>
<div><b>Reason:</b> Add <code>ip route</code> examples; add alternative using NAT; mention the situation when the <i>site</i>-peer is the network's gateway. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<p>If the intent is to connect a device to a network with WireGuard peer(s), set up routes on each device so they know that the peer(s) are reachable via the device.
</p>
<div class="archwiki-template-box archwiki-template-box-tip"><strong>Tip:</strong> Deploy routes network-wide by configuring them in the router.</div>
<p>Enable IP forwarding on the peer through which other devices on the network will connect to WireGuard peer(s):
</p>
<pre># sysctl -w net.ipv4.ip_forward=1
# sysctl -w net.ipv6.conf.all.forwarding=1
</pre>
<div class="archwiki-template-box archwiki-template-box-warning"><strong>Warning:</strong> Enabling IP forwarding without a properly configured <a title="Firewall" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Firewall">firewall</a> is a security risk.</div>
<p>See <a title="Sysctl" href="https://wiki.archlinux.org/title/WireGuard/title/Sysctl#Configuration">sysctl#Configuration</a> for instructions on how to set the <i>sysctl</i> parameters on boot.
</p>
<h5><span id="Site-to-site" class="mw-headline">Site-to-site</span></h5>
<p>To connect two (or more) networks, apply both <a href="https://wiki.archlinux.org/title/WireGuard#Point-to-site">#Point-to-site</a> and <a href="https://wiki.archlinux.org/title/WireGuard#Site-to-point">#Site-to-point</a> on all <i>sites</i>.
</p>
<h5><span id="Routing_all_traffic_over_WireGuard" class="mw-headline">Routing all traffic over WireGuard</span></h5>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-view-fullscreen.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/3/38/Tango-view-fullscreen.png" alt="Tango-view-fullscreen.png"></a><b>This article or section needs expansion.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-view-fullscreen.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/3/38/Tango-view-fullscreen.png" alt="Tango-view-fullscreen.png"></a></p>
<div><b>Reason:</b> Add instructions on how to <i>route everything over VPN</i>.<a href="https://www.wireguard.com/netns/" class="external autonumber" rel="nofollow">[1]</a> There is <a href="https://wiki.archlinux.org/title/WireGuard#systemd-networkd:_routing_all_traffic_over_WireGuard">#systemd-networkd: routing all traffic over WireGuard</a> already. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<h4><span id="DNS" class="mw-headline">DNS</span></h4>
<p>To use a peer as a DNS server, add its WireGuard tunnel IP address(es) to <a title="/etc/resolv.conf" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title//etc/resolv.conf">/etc/resolv.conf</a>. For example, to use peer B as the DNS server:
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/resolv.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">nameserver fdc9:281f:04d7:9ee9::2
nameserver 10.0.0.2
</pre>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> If a peer will act as a DNS server, make sure to use its WireGuard tunnel address(es) as the DNS server address(es) instead of another of its addresses from allowed IPs. Otherwise DNS lookups may fail.</div>
<h3><span id="Basic_checkups" class="mw-headline">Basic checkups</span></h3>
<p>Invoking the <span title="$ man 8 wg" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg.8" class="external text" rel="nofollow">wg(8)</a></span> command without parameters will give a quick overview of the current configuration.
</p><p>As an example, when peer A has been configured we are able to see its identity and its associated peers:
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;"># wg</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">interface: wg0
  public key: UguPyBThx/+xMXeTbRYkKlP0Wh/QZT3vTLPOVaaXTD8=
  private key: (hidden)
  listening port: 51871

peer: 9jalV3EEBnVXahro0pRMQ+cHlmjE33Slo9tddzCVtCw=
  endpoint: 203.0.113.102:51902
  allowed ips: 10.0.0.2/32, fdc9:281f:04d7:9ee9::2

peer: 2RzKFbGMx5g7fG0BrWCI7JIpGvcwGkqUaCoENYueJw4=
  endpoint: 192.0.2.103:51993
  allowed ips: 10.0.0.3/32, fdc9:281f:04d7:9ee9::3</pre>
<p>At this point one could reach the end of the tunnel. If the peers do not block ICMP echo requests, try <a title="Ping" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Ping">pinging</a> a peer to test the connection between them.
</p><p>Using ICMPv4:
</p>
<pre>$ ping 10.0.0.2
</pre>
<p>Using ICMPv6:
</p>
<pre>$ ping fdc9:281f:04d7:9ee9::2
</pre>
<p>After transferring some data between peers, the <code>wg</code> utility will show additional information:
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;"># wg</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">interface: wg0
  public key: UguPyBThx/+xMXeTbRYkKlP0Wh/QZT3vTLPOVaaXTD8=
  private key: (hidden)
  listening port: 51871

peer: 9jalV3EEBnVXahro0pRMQ+cHlmjE33Slo9tddzCVtCw=
  endpoint: 203.0.113.102:51902
  allowed ips: 10.0.0.2/32, fdc9:281f:04d7:9ee9::2
  latest handshake: 5 seconds ago
  transfer: 1.24 KiB received, 1.38 KiB sent

peer: 2RzKFbGMx5g7fG0BrWCI7JIpGvcwGkqUaCoENYueJw4=
  allowed ips: 10.0.0.3/32, fdc9:281f:04d7:9ee9::3</pre>
<h3><span id="Persistent_configuration" class="mw-headline">Persistent configuration</span></h3>
<p>Persistent configuration can be achieved using <code>wg-quick@.service</code>, which is shipped with <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=wireguard-tools" class="external text" rel="nofollow">wireguard-tools</a></span>, or using a network manager. Network managers that support WireGuard are <a title="Systemd-networkd" href="https://wiki.archlinux.org/title/WireGuard/title/Systemd-networkd">systemd-networkd</a>, <a title="Netctl" href="https://wiki.archlinux.org/title/WireGuard/title/Netctl">netctl</a><a href="https://gitlab.archlinux.org/archlinux/netctl/blob/master/docs/examples/wireguard" class="external autonumber" rel="nofollow">[2]</a>, <a title="NetworkManager" href="https://wiki.archlinux.org/title/WireGuard/title/NetworkManager">NetworkManager</a> and <a title="ConnMan" href="https://wiki.archlinux.org/title/WireGuard/title/ConnMan">ConnMan</a><a href="https://git.kernel.org/pub/scm/network/connman/connman.git/tree/doc/vpn-config-format.txt" class="external autonumber" rel="nofollow">[3]</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> 
<ul><li><a title="Netctl" href="https://wiki.archlinux.org/title/WireGuard/title/Netctl">netctl</a> relies on <span title="$ man 8 wg" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg.8" class="external text" rel="nofollow">wg(8)</a></span> from <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=wireguard-tools" class="external text" rel="nofollow">wireguard-tools</a></span> and <code>/etc/wireguard/<i>interfacename</i>.conf</code> configuration files for establishing WireGuard connections.</li>
<li><a title="ConnMan" href="https://wiki.archlinux.org/title/WireGuard/title/ConnMan">ConnMan</a> has a very limited support for WireGuard. It can connect to only one peer.<a href="https://git.kernel.org/pub/scm/network/connman/connman.git/commit/?id=95b25140bec7c4d9b6ae4e479dc1b94b7d409b39" class="external autonumber" rel="nofollow">[4]</a></li></ul></div>
<h4><span id="wg-quick" class="mw-headline">wg-quick</span></h4>
<p><span title="$ man 8 wg-quick" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg-quick.8" class="external text" rel="nofollow">wg-quick(8)</a></span> configures WireGuard tunnels using configuration files from <code>/etc/wireguard/<i>interfacename</i>.conf</code>.
</p><p>The current WireGuard configuration can be saved by utilizing the <span title="$ man 8 wg" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg.8" class="external text" rel="nofollow">wg(8)</a></span> utility's <code>showconf</code> command. For example:
</p>
<pre># wg showconf wg0 &gt; /etc/wireguard/wg0.conf
</pre>
<p>To start a tunnel with a configuration file, use
</p>
<pre># wg-quick up <i>interfacename</i>
</pre>
<p>or use the systemd service—<code>wg-quick@<i>interfacename</i>.service</code>. To start the tunnel at boot, <a title="Enable" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Enable">enable</a> the unit.
</p>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> 
<ul><li>Users configuring the WireGuard interface using <i>wg-quick</i>, should make sure that no other <a title="Network management" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Network_management">network management</a> software tries to manage it. To use <a title="NetworkManager" href="https://wiki.archlinux.org/title/WireGuard/title/NetworkManager">NetworkManager</a> and to not configure WireGuard interfaces with it, see <a href="https://wiki.archlinux.org/title/WireGuard#Routes_are_periodically_reset">#Routes are periodically reset</a>.</li>
<li><i>wg-quick</i> adds additional configuration options to the configuration file format thus making it incompatible with <span title="$ man 8 wg" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg.8#CONFIGURATION_FILE_FORMAT" class="external text" rel="nofollow">wg(8) § CONFIGURATION FILE FORMAT</a></span>. See the <span title="$ man 8 wg-quick" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg-quick.8#CONFIGURATION" class="external text" rel="nofollow">wg-quick(8) § CONFIGURATION</a></span> man page for the configuration values in question. A <i>wg</i>-compatible configuration file can be produced by using <code>wg-quick strip</code>.</li>
<li><i>wg-quick</i> does not provide a way to instruct <a title="Resolvconf" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Resolvconf">resolvconf</a> to set the WireGuard interface as <i>private</i>. Even if there are search domains specified, all DNS queries from the system, not just those that match the search domains, will be sent to the DNS servers which are set in the WireGuard configuration.</li></ul>
</div>
<p><b>Peer A setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.0.0.1/24, fdc9:281f:04d7:9ee9::1/64
ListenPort = 51871
PrivateKey = <i>PEER_A_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_B_PUBLIC_KEY</i>
PresharedKey = <i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.2/32, fdc9:281f:04d7:9ee9::2/128
Endpoint = peer-b.example:51902

[Peer]
PublicKey = <i>PEER_C_PUBLIC_KEY</i>
PresharedKey = <i>PEER_A-PEER_C-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.3/32, fdc9:281f:04d7:9ee9::3/128</pre>
<ul><li>To <i>route all traffic</i> through the tunnel to a specific peer, add the <a title="wikipedia:Default route" class="extiw" href="https://en.wikipedia.org/wiki/Default_route">default route</a> (<code>0.0.0.0/0</code> for IPv4 and <code>::/0</code> for IPv6) to <code>AllowedIPs</code>. E.g. <code>AllowedIPs = 0.0.0.0/0,&nbsp;::/0</code>. wg-quick will automatically take care of setting up correct routing and fwmark<a href="https://www.wireguard.com/netns/#routing-all-your-traffic" class="external autonumber" rel="nofollow">[5]</a> so that networking still functions.</li>
<li>To use a peer as a DNS server, set <code>DNS = <i>wireguard_internal_ip_address_of_peer</i></code> in the <code>[Interface]</code> section. <a title="wikipedia:Search domain" class="extiw" href="https://en.wikipedia.org/wiki/Search_domain">Search domains</a> are also set with the <code>DNS =</code> option. Separate all values in the list with commas.</li></ul>
<p><b>Peer B setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.0.0.2/24, fdc9:281f:04d7:9ee9::2/64
ListenPort = 51902
PrivateKey = <i>PEER_B_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_A_PUBLIC_KEY</i>
PresharedKey = <i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.1/32, fdc9:281f:04d7:9ee9::1/128
Endpoint = 198.51.100.101:51871

[Peer]
PublicKey = <i>PEER_C_PUBLIC_KEY</i>
PresharedKey = <i>PEER_B-PEER_C-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.3/32, fdc9:281f:04d7:9ee9::3/128</pre>
<p><b>Peer C setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.0.0.3/24, fdc9:281f:04d7:9ee9::3/64
ListenPort = 51993
PrivateKey = <i>PEER_C_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_A_PUBLIC_KEY</i>
PresharedKey = <i>PEER_A-PEER_C-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.1/32, fdc9:281f:04d7:9ee9::1/128
Endpoint = 198.51.100.101:51871

[Peer]
PublicKey = <i>PEER_B_PUBLIC_KEY</i>
PresharedKey = <i>PEER_B-PEER_C-PRESHARED_KEY</i>
AllowedIPs = 10.0.0.2/32, fdc9:281f:04d7:9ee9::2/128
Endpoint = peer-b.example:51902</pre>
<h4><span id="systemd-networkd" class="mw-headline">systemd-networkd</span></h4>
<p><a title="Systemd-networkd" href="https://wiki.archlinux.org/title/WireGuard/title/Systemd-networkd">systemd-networkd</a> has native support for setting up WireGuard interfaces. An example is provided in the <span title="$ man 5 systemd.netdev" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/systemd.netdev.5#EXAMPLES" class="external text" rel="nofollow">systemd.netdev(5) § EXAMPLES</a></span> man page.
</p>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> Routing all DNS over WireGuard (i.e. <code>Domains=~.</code>) will prevent the DNS resolution of endpoints.</div>
<p><b>Peer A setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.netdev</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[NetDev]
Name=wg0
Kind=wireguard
Description=WireGuard tunnel wg0

[WireGuard]
ListenPort=51871
PrivateKey=<i>PEER_A_PRIVATE_KEY</i>

[WireGuardPeer]
PublicKey=<i>PEER_B_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs=10.0.0.2/32
AllowedIPs=fdc9:281f:04d7:9ee9::2/128
Endpoint=peer-b.example:51902

[WireGuardPeer]
PublicKey=<i>PEER_C_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_C-PRESHARED_KEY</i>
AllowedIPs=10.0.0.3/32
AllowedIPs=fdc9:281f:04d7:9ee9::3/128</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Match]
Name=wg0

[Network]
Address=10.0.0.1/24
Address=fdc9:281f:04d7:9ee9::1/64</pre>
<ul><li>To use a peer as a DNS server, specify its WireGuard tunnel's IP address(es) in the <i>.network</i> file using the <code>DNS=</code> option. For <a title="wikipedia:Search domain" class="extiw" href="https://en.wikipedia.org/wiki/Search_domain">search domains</a> use the <code>Domains=</code> option. See <span title="$ man 5 systemd.network" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/systemd.network.5#%5BNETWORK%5D_SECTION_OPTIONS" class="external text" rel="nofollow">systemd.network(5) § [NETWORK] SECTION OPTIONS</a></span> for details.</li>
<li>To use a peer as the <b>only</b> DNS server, then in the <i>.network</i> file's <code>[Network]</code> section set <code>DNSDefaultRoute=true</code> and add <code>~.</code> to <code>Domains=</code> option.</li>
<li>To route additional subnets add them as <code>[Route]</code> sections in the <i>.network</i> file. For example:</li></ul>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...
[Route]
Destination=192.168.35.0/24
Scope=link

[Route]
Destination=fd7b:d0bd:7a6e::/64
Scope=link</pre>
<div class="archwiki-template-box archwiki-template-box-warning"><strong>Warning:</strong> In order to prevent the leaking of private keys, it is recommended to set the permissions of the <i>.netdev</i> file:
<pre># chown root:systemd-network /etc/systemd/network/99-*.netdev
# chmod 0640 /etc/systemd/network/99-*.netdev
</pre>
</div>
<p><b>Peer B setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.netdev</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[NetDev]
Name=wg0
Kind=wireguard
Description=WireGuard tunnel wg0

[WireGuard]
ListenPort=51902
PrivateKey=<i>PEER_B_PRIVATE_KEY</i>

[WireGuardPeer]
PublicKey=<i>PEER_A_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs=10.0.0.1/32
AllowedIPs=fdc9:281f:04d7:9ee9::1/128
Endpoint=198.51.100.101:51871

[WireGuardPeer]
PublicKey=<i>PEER_C_PUBLIC_KEY</i>
PresharedKey=<i>PEER_B-PEER_C-PRESHARED_KEY</i>
AllowedIPs=10.0.0.3/32
AllowedIPs=fdc9:281f:04d7:9ee9::3/128</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Match]
Name=wg0

[Network]
Address=10.0.0.2/24
Address=fdc9:281f:04d7:9ee9::2/64</pre>
<p><b>Peer C setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.netdev</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[NetDev]
Name=wg0
Kind=wireguard
Description=WireGuard tunnel wg0

[WireGuard]
ListenPort=51993
PrivateKey=<i>PEER_C_PRIVATE_KEY</i>

[WireGuardPeer]
PublicKey=<i>PEER_A_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_C-PRESHARED_KEY</i>
AllowedIPs=10.0.0.1/32
AllowedIPs=fdc9:281f:04d7:9ee9::1/128
Endpoint=198.51.100.101:51871

[WireGuardPeer]
PublicKey=<i>PEER_B_PUBLIC_KEY</i>
PresharedKey=<i>PEER_B-PEER_C-PRESHARED_KEY</i>
AllowedIPs=10.0.0.2/32
AllowedIPs=fdc9:281f:04d7:9ee9::2/128
Endpoint=peer-b.example:51902</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Match]
Name=wg0

[Network]
Address=10.0.0.3/24
Address=fdc9:281f:04d7:9ee9::3/64</pre>
<h4><span id="systemd-networkd:_routing_all_traffic_over_WireGuard" class="mw-headline">systemd-networkd: routing all traffic over WireGuard</span></h4>
<p>In this example Peer B connects to peer A with public IP address. Peer B routes all its traffic over WireGuard tunnel and uses Peer A for handling DNS requests.
</p><p><b>Peer A setup</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.netdev</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[NetDev]
Name=wg0
Kind=wireguard
Description=WireGuard tunnel wg0

[WireGuard]
ListenPort=51871
PrivateKey=<i>PEER_A_PRIVATE_KEY</i>

[WireGuardPeer]
PublicKey=<i>PEER_B_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs=10.0.0.2/32</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Match]
Name=wg0

[Network]
Address=10.0.0.1/24</pre>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> You must still enable <a title="Internet sharing" href="https://wiki.archlinux.org/title/WireGuard/title/Internet_sharing#Enable_packet_forwarding">IP Forwarding</a> and IP masquerading rules on Peer A in order to provide working internet to Peer B.
<p>Assumes <a title="Ufw" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Ufw">ufw</a>, but you could do the same with <a title="Iptables" href="https://wiki.archlinux.org/title/WireGuard/title/Iptables">iptables</a> by using the rules outlined in the <a href="https://wiki.archlinux.org/title/WireGuard#Server_configuration">Server configuration</a> section:
</p>
<pre>$ ufw route allow in on wg0 out on enp5s0
</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/ufw/before.rules</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">*nat
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s 10.0.0.0/24 -o enp5s0 -j MASQUERADE
COMMIT</pre>
</div>
<p><b>Peer B setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/99-wg0.netdev</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[NetDev]
Name=wg0
Kind=wireguard
Description=WireGuard tunnel wg0

[WireGuard]
ListenPort=51902
PrivateKey=<i>PEER_B_PRIVATE_KEY</i>
FirewallMark=0x8888

[WireGuardPeer]
PublicKey=<i>PEER_A_PUBLIC_KEY</i>
PresharedKey=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
AllowedIPs=0.0.0.0/0
Endpoint=198.51.100.101:51871</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/50-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Match]
Name=wg0

[Network]
Address=10.0.0.2/24
DNS=10.0.0.1
DNSDefaultRoute=true
Domains=~.

[RoutingPolicyRule]
FirewallMark=0x8888
InvertRule=true
Table=1000
Priority=10

[Route]
Gateway=10.0.0.1
GatewayOnLink=true
Table=1000</pre>
<p><b>Exempting specific addresses</b>
</p><p>In order to exempt specific addresses (such as private LAN addresses) from routing over the WireGuard tunnel, add them to a higher-priority RoutingPolicyRule than the one that was just created.  This will configure them to use the default routing table, and prevent them from using the WireGuard table.
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/network/50-wg0.network</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">...

[RoutingPolicyRule]
To=192.168.0.0/24
Priority=9

...</pre>
<h4><span id="Netctl" class="mw-headline">Netctl</span></h4>
<p><a title="Netctl" href="https://wiki.archlinux.org/title/WireGuard/title/Netctl">Netctl</a> has native support for setting up WireGuard interfaces. A typical set of WireGuard netctl profile configuration files would look like this:
</p><p><b>Peer A setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/netctl/wg0</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Description="WireGuard tunnel on peer A"
Interface=wg0
Connection=wireguard
WGConfigFile=/etc/wireguard/wg0.conf

IP=static
Address=('10.0.0.1/24')</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
ListenPort = 51871
PrivateKey = <i>PEER_A_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_B_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.2/32
Endpoint = peer-b.example:51902

[Peer]
PublicKey = <i>PEER_C_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.3/32</pre>
<p><b>Peer B setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/netctl/wg0</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Description="WireGuard tunnel on peer B"
Interface=wg0
Connection=wireguard
WGConfigFile=/etc/wireguard/wg0.conf

IP=static
Address=('10.0.0.2/24')</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
ListenPort = 51902
PrivateKey = <i>PEER_B_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_A_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.1/32
Endpoint = peer-a.example:51871

[Peer]
PublicKey = <i>PEER_C_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.3/32</pre>
<p><b>Peer C setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/netctl/wg0</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Description="WireGuard tunnel on peer C"
Interface=wg0
Connection=wireguard
WGConfigFile=/etc/wireguard/wg0.conf

IP=static
Address=('10.0.0.3/24')</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
ListenPort = 51993
PrivateKey = <i>PEER_C_PRIVATE_KEY</i>

[Peer]
PublicKey = <i>PEER_A_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.1/32
Endpoint = peer-a.example:51871

[Peer]
PublicKey = <i>PEER_B_PUBLIC_KEY</i>
AllowedIPs = 10.0.0.2/32
Endpoint = peer-b.example:51902</pre>
<p>Then start and/or enable wg0 interface on every participating peer as needed, i.e.
</p>
<pre># netctl start wg0
</pre>
<p>To implement persistent site-to-peer, peer-to-site or site-to-site type of connection with WireGuard and Netctl, just add appropriate <code>Routes=</code> line into the netctl profile configuration file and add this network to <code>AllowedIPs</code> in the WireGuard profile, e.g. <code>Routes=('192.168.10.0/24 dev wg0')</code> in the <code>/etc/netctl/wg0</code> and <code>AllowedIPs=10.0.0.1/32, 192.168.10.0/24</code> in <code>/etc/wireguard/wg0.conf</code> and then do not forget to enable <a title="Internet sharing" href="https://wiki.archlinux.org/title/WireGuard/title/Internet_sharing#Enable_packet_forwarding">IP forwarding</a>.
</p>
<h4><span id="NetworkManager" class="mw-headline">NetworkManager</span></h4>
<p><a title="NetworkManager" href="https://wiki.archlinux.org/title/WireGuard/title/NetworkManager">NetworkManager</a> has native support for setting up WireGuard interfaces. For all details about WireGuard usage in NetworkManager, read Thomas Haller's blog post—<a href="https://blogs.gnome.org/thaller/2019/03/15/wireguard-in-networkmanager/" class="external text" rel="nofollow">WireGuard in NetworkManager</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-tip"><strong>Tip:</strong> NetworkManager can import a wg-quick configuration file. E.g.: <pre># nmcli connection import type wireguard file /etc/wireguard/wg0.conf</pre></div>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> nmcli can create a WireGuard connection profile, but it does not support configuring peers. See <a href="https://gitlab.freedesktop.org/NetworkManager/NetworkManager/issues/358" class="external text" rel="nofollow">NetworkManager issue 358</a>.</div>
<p>The following examples configure WireGuard via the keyfile format <i>.nmconnection</i> files. See <span title="$ man 5 nm-settings-keyfile" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/nm-settings-keyfile.5" class="external text" rel="nofollow">nm-settings-keyfile(5)</a></span> and <span title="$ man 5 nm-settings" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/nm-settings.5" class="external text" rel="nofollow">nm-settings(5)</a></span> for an explanation on the syntax and available options.
</p><p><b>Peer A setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/NetworkManager/system-connections/wg0.nmconnection</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[connection]
id=wg0
type=wireguard
interface-name=wg0

[wireguard]
listen-port=51871
private-key=<i>PEER_A_PRIVATE_KEY</i>
private-key-flags=0

[wireguard-peer.<i>PEER_B_PUBLIC_KEY</i>]
endpoint=peer-b.example:51902
preshared-key=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.2/32;fdc9:281f:04d7:9ee9::2/128;

[wireguard-peer.<i>PEER_C_PUBLIC_KEY</i>]
preshared-key=<i>PEER_A-PEER_C-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.3/32;fdc9:281f:04d7:9ee9::3/128;

[ipv4]
address1=10.0.0.1/24
method=manual

[ipv6]
address1=fdc9:281f:04d7:9ee9::1/64
method=manual</pre>
<ul><li>To <i>route all traffic</i> through the tunnel to a specific peer, add the <a title="wikipedia:Default route" class="extiw" href="https://en.wikipedia.org/wiki/Default_route">default route</a> (<code>0.0.0.0/0</code> for IPv4 and <code>::/0</code> for IPv6) to <code>wireguard-peer.<i>PEER_X_PUBLIC_KEY</i>.allowed-ips</code>. E.g. <code>wireguard-peer.<i>PEER_B_PUBLIC_KEY</i>.allowed-ips=0.0.0.0/0;::/0;</code>. Special handling of the default route in WireGuard connections is supported since NetworkManager 1.20.0.</li>
<li>To use a peer as a DNS server, specify its WireGuard tunnel's IP address(es) with the <code>ipv4.dns</code> and <code>ipv6.dns</code> settings. <a title="wikipedia:Search domain" class="extiw" href="https://en.wikipedia.org/wiki/Search_domain">Search domains</a> can be specified with the <code>ipv4.dns-search=</code> and <code>ipv6.dns-search=</code> options. See <span title="$ man 5 nm-settings" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/nm-settings.5" class="external text" rel="nofollow">nm-settings(5)</a></span> for more details. For example, using the keyfile format:</li></ul>
<pre>...
[ipv4]
...
dns=10.0.0.2;
dns-search=corp;
...
[ipv6]
...
dns=fdc9:281f:04d7:9ee9::2;
dns-search=corp;
...</pre>
<p>To use a peer as the <b>only</b> DNS server, set a negative DNS priority (e.g. <code>dns-priority=-1</code>) and add <code>~.</code> to the <code>dns-search=</code> settings.
</p><p><b>Peer B setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/NetworkManager/system-connections/wg0.nmconnection</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[connection]
id=wg0
type=wireguard
interface-name=wg0

[wireguard]
listen-port=51902
private-key=<i>PEER_B_PRIVATE_KEY</i>
private-key-flags=0

[wireguard-peer.<i>PEER_A_PUBLIC_KEY</i>]
endpoint=198.51.100.101:51871
preshared-key=<i>PEER_A-PEER_B-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.1/32;fdc9:281f:04d7:9ee9::1/128;

[wireguard-peer.<i>PEER_C_PUBLIC_KEY</i>]
preshared-key=<i>PEER_B-PEER_C-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.3/32;fdc9:281f:04d7:9ee9::3/128;

[ipv4]
address1=10.0.0.2/24
method=manual

[ipv6]
address1=fdc9:281f:04d7:9ee9::2/64
method=manual</pre>
<p><b>Peer C setup:</b>
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/NetworkManager/system-connections/wg0.nmconnection</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[connection]
id=wg0
type=wireguard
interface-name=wg0

[wireguard]
listen-port=51993
private-key=<i>PEER_C_PRIVATE_KEY</i>
private-key-flags=0

[wireguard-peer.<i>PEER_A_PUBLIC_KEY</i>]
endpoint=198.51.100.101:51871
preshared-key=<i>PEER_A-PEER_C-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.1/32;fdc9:281f:04d7:9ee9::1/128;

[wireguard-peer.<i>PEER_B_PUBLIC_KEY</i>]
endpoint=peer-b.example:51902
preshared-key=<i>PEER_B-PEER_C-PRESHARED_KEY</i>
preshared-key-flags=0
allowed-ips=10.0.0.2/32;fdc9:281f:04d7:9ee9::2/128;

[ipv4]
address1=10.0.0.3/24
method=manual

[ipv6]
address1=fdc9:281f:04d7:9ee9::3/64
method=manual</pre>
<h2><span id="Specific_use-case:_VPN_server" class="mw-headline">Specific use-case: VPN server</span></h2>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Merge-arrows-2.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/c/c9/Merge-arrows-2.png" alt="Merge-arrows-2.png"></a><b>This article or section is a candidate for merging with <a href="https://wiki.archlinux.org/title/WireGuard#Routing_all_traffic_over_WireGuard">#Routing all traffic over WireGuard</a>.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Merge-arrows-2.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/c/c9/Merge-arrows-2.png" alt="Merge-arrows-2.png"></a></p>
<div><b>Notes:</b> Same use case. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> Usage of the terms "server" and "client" were purposefully chosen in this section specifically to help new users/existing OpenVPN users become familiar with the construction of WireGuard's configuration files.  WireGuard documentation simply refers to both of these concepts as "peers."</div>
<p>The purpose of this section is to set up a WireGuard "server" and generic "clients" to enable access to the server/network resources through an encrypted and secured tunnel like <a title="OpenVPN" href="https://wiki.archlinux.org/title/WireGuard/title/OpenVPN">OpenVPN</a> and others.  The "server" runs on Linux and the "clients" can run on any number of platforms (the WireGuard Project offers apps on both iOS and Android platforms in addition to Linux, Windows and MacOS).  See the official project <a href="https://www.wireguard.com/install/" class="external text" rel="nofollow">install link</a> for more.
</p>
<div class="archwiki-template-box archwiki-template-box-tip"><strong>Tip:</strong> Instead of using <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=wireguard-tools" class="external text" rel="nofollow">wireguard-tools</a></span> for server/client configuration, one may also use <a href="https://wiki.archlinux.org/title/WireGuard#systemd-networkd">systemd-networkd</a> native WireGuard support.</div>
<h3><span id="Server" class="mw-headline">Server</span></h3>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Merge-arrows-2.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/c/c9/Merge-arrows-2.png" alt="Merge-arrows-2.png"></a><b>This article or section is a candidate for merging with <a href="https://wiki.archlinux.org/title/WireGuard#Site-to-point">#Site-to-point</a>.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Merge-arrows-2.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/c/c9/Merge-arrows-2.png" alt="Merge-arrows-2.png"></a></p>
<div><b>Notes:</b> Same use case. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<p>On the peer that will act as the "server", first enable IPv4 forwarding using <a title="Sysctl" href="https://wiki.archlinux.org/title/WireGuard/title/Sysctl">sysctl</a>:
</p>
<pre># sysctl -w net.ipv4.ip_forward=1
</pre>
<p>To make the change permanent, add <code>net.ipv4.ip_forward = 1</code> to <code>/etc/sysctl.d/99-sysctl.conf</code>.
</p><p>A properly configured <a title="Firewall" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Firewall">firewall</a> is <i>HIGHLY recommended</i> for any Internet-facing device.
</p><p>If the server has a public IP configured, be sure to:
</p>
<ul><li>Allow UDP traffic on the specified port(s) on which WireGuard will be running (for example allowing traffic on <code>51820/UDP</code>).</li>
<li>Setup the forwarding policy for the firewall if it is not included in the WireGuard configuration for the interface itself <code>/etc/wireguard/wg0.conf</code>. The example below should have the iptables rules and work as-is.</li></ul>
<p>If the server is behind NAT, be sure to forward the specified port(s) on which WireGuard will be running (for example, <code>51820/UDP</code>) from the router to the WireGuard server.
</p>
<h3><span id="Key_generation_2" class="mw-headline">Key generation</span></h3>
<p>Generate key pairs for the server and for each client as explained in <a href="https://wiki.archlinux.org/title/WireGuard#Key_generation">#Key generation</a>.
</p>
<h3><span id="Server_configuration" class="mw-headline">Server configuration</span></h3>
<p>Create the "server" configuration file:
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/wireguard/wg0.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.200.200.1/24
ListenPort = 51820
PrivateKey = <i>SERVER_PRIVATE_KEY</i>

# substitute <i>eth0</i> in the following lines to match the Internet-facing interface
# if the server is behind a router and receives traffic via NAT, these iptables rules are not needed
PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
# foo
PublicKey = <i>PEER_FOO_PUBLIC_KEY</i>
PresharedKey = <i>PRE-SHARED_KEY</i>
AllowedIPs = 10.200.200.2/32

[Peer]
# bar
PublicKey = <i>PEER_BAR_PUBLIC_KEY</i>
PresharedKey = <i>PRE-SHARED_KEY</i>
AllowedIPs = 10.200.200.3/32</pre>
<p>Additional peers ("clients") can be listed in the same format as needed. Each peer requires the <code>PublicKey</code> to be set. However, specifying <code>PresharedKey</code> is optional.
</p><p>Notice that the <code>Address</code> has a netmask of <code>/24</code> and the clients on <code>AllowedIPs</code> <code>/32</code>. The clients only use their IP and the server only sends back their respective address.
</p><p>The interface can be managed manually using <span title="$ man 8 wg-quick" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg-quick.8" class="external text" rel="nofollow">wg-quick(8)</a></span> or using a <a title="Systemd" href="https://wiki.archlinux.org/title/WireGuard/title/Systemd">systemd</a> service managed via <span title="$ man 1 systemctl" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/systemctl.1" class="external text" rel="nofollow">systemctl(1)</a></span>.
</p><p>The interface may be brought up using <code>wg-quick up wg0</code> respectively by <a title="Start" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Start">starting</a> and potentially <a title="Enable" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Enable">enabling</a> the interface via <code>wg-quick@<i>interface</i>.service</code>, e.g. <code>wg-quick@wg0.service</code>. To close the interface use <code>wg-quick down wg0</code> respectively <a title="Stop" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Stop">stop</a> <code>wg-quick@<i>interface</i>.service</code>.
</p>
<h3><span id="Client_configuration" class="mw-headline">Client configuration</span></h3>
<p>Create the corresponding "client" configuration file(s):
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">foo.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.200.200.2/32
PrivateKey = <i>PEER_FOO_PRIVATE_KEY</i>
DNS = 10.200.200.1

[Peer]
PublicKey = <i>SERVER_PUBLICKEY</i>
PresharedKey = <i>PRE-SHARED_KEY</i>
Endpoint = my.ddns.example.com:51820
AllowedIPs = 0.0.0.0/0,&nbsp;::/0</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">bar.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.200.200.3/32
PrivateKey = <i>PEER_BAR_PRIVATE_KEY</i>
DNS = 10.200.200.1

[Peer]
PublicKey = <i>SERVER_PUBLICKEY</i>
PresharedKey = <i>PRE-SHARED KEY</i>
Endpoint = my.ddns.example.com:51820
AllowedIPs = 0.0.0.0/0,&nbsp;::/0</pre>
<p>Using the catch-all <code>AllowedIPs = 0.0.0.0/0,&nbsp;::/0</code> will forward all IPv4 (<code>0.0.0.0/0</code>) and IPv6 (<code>::/0</code>) traffic over the VPN.
</p>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> Users of <a title="NetworkManager" href="https://wiki.archlinux.org/title/WireGuard/title/NetworkManager">NetworkManager</a>, may need to <a title="Enable" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Enable">enable</a> the <code>NetworkManager-wait-online.service</code> and users of <a title="Systemd-networkd" href="https://wiki.archlinux.org/title/WireGuard/title/Systemd-networkd">systemd-networkd</a> may need to <a title="Enable" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Enable">enable</a> the <code>systemd-networkd-wait-online.service</code> to wait until devices are network-ready before attempting a WireGuard connection.</div>
<h2><span id="Testing_the_tunnel" class="mw-headline">Testing the tunnel</span></h2>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Merge-arrows-2.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/c/c9/Merge-arrows-2.png" alt="Merge-arrows-2.png"></a><b>This article or section is a candidate for merging with <a href="https://wiki.archlinux.org/title/WireGuard#Basic_checkups">#Basic checkups</a>.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Merge-arrows-2.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/c/c9/Merge-arrows-2.png" alt="Merge-arrows-2.png"></a></p>
<div><b>Notes:</b> Same topic. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<p>Once a tunnel has been established, one can use <a title="Netcat" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Netcat">netcat</a> to send traffic through it to test out throughput, CPU usage, etc.
On one side of the tunnel, run <code>nc</code> in listen mode and on the other side, pipe some data from <code>/dev/zero</code> into <code>nc</code> in sending mode.
</p><p>In the example below, port 2222 is used for the traffic (be sure to allow traffic on port 2222 if using a firewall).
</p><p>On one side of the tunnel listen for traffic:
</p>
<pre>$ nc -vvlnp 2222
</pre>
<p>On the other side of the tunnel, send some traffic:
</p>
<pre>$ dd if=/dev/zero bs=1024K count=1024 | nc -v 10.0.0.203 2222
</pre>
<p>Status can be monitored using <code>wg</code> directly.
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;"># wg</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">interface: wg0
  public key: UguPyBThx/+xMXeTbRYkKlP0Wh/QZT3vTLPOVaaXTD8=
  private key: (hidden)
  listening port: 51820

peer: 9jalV3EEBnVXahro0pRMQ+cHlmjE33Slo9tddzCVtCw=
  preshared key: (hidden)
  endpoint: 192.168.1.216:53207
  allowed ips: 10.0.0.0/0
  latest handshake: 1 minutes, 17 seconds ago
  transfer: 56.43 GiB received, 1.06 TiB sent</pre>
<h2><span id="Tips_and_tricks" class="mw-headline">Tips and tricks</span></h2>
<h3><span id="Store_private_keys_in_encrypted_form" class="mw-headline">Store private keys in encrypted form</span></h3>
<p>It may be desirable to store private keys in encrypted form, such as through use of <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=pass" class="external text" rel="nofollow">pass</a></span>. Just replace the PrivateKey line under [Interface] in the configuration file with:
</p>
<pre>PostUp = wg set %i private-key &lt;(su user -c "export PASSWORD_STORE_DIR=/path/to/your/store/; pass WireGuard/private-keys/%i")
</pre>
<p>where <i>user</i> is the Linux username of interest. See the <span title="$ man 8 wg-quick" class="plainlinks archwiki-template-man"><a href="https://man.archlinux.org/man/wg-quick.8" class="external text" rel="nofollow">wg-quick(8)</a></span> man page for more details.
</p>
<h3><span id="Endpoint_with_changing_IP" class="mw-headline">Endpoint with changing IP</span></h3>
<p>After resolving a server's domain, WireGuard <a href="https://lists.zx2c4.com/pipermail/wireguard/2017-November/002028.html" class="external text" rel="nofollow">will not check for changes in DNS again</a>.
</p><p>If the WireGuard server is frequently changing its IP-address due DHCP, Dyndns, IPv6, etc., any WireGuard client is going to lose its connection, until its endpoint is updated via something like <code>wg set "$INTERFACE" peer "$PUBLIC_KEY" endpoint "$ENDPOINT"</code>.
</p><p>Also be aware, if the endpoint is ever going to change its address (for example when moving to a new provider/datacenter), just updating DNS will not be enough, so periodically running reresolve-dns might make sense on any DNS-based setup.
</p><p>Luckily, <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=wireguard-tools" class="external text" rel="nofollow">wireguard-tools</a></span> provides an example script <code>/usr/share/wireguard-tools/examples/reresolve-dns/reresolve-dns.sh</code>, that parses WG configuration files and automatically resets the endpoint address.
</p><p>One needs to run the <code>/usr/share/wireguard-tools/examples/reresolve-dns/reresolve-dns.sh /etc/wireguard/wg.conf</code> periodically to recover from an endpoint that has changed its IP.
</p><p>One way of doing so is by updating all WireGuard endpoints once every thirty seconds<a href="https://git.zx2c4.com/WireGuard/tree/contrib/examples/reresolve-dns/README" class="external autonumber" rel="nofollow">[6]</a> via a systemd timer:
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/system/wireguard_reresolve-dns.timer</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Periodically reresolve DNS of all WireGuard endpoints

[Timer]
OnCalendar=*:*:0/30

[Install]
WantedBy=timers.target</pre>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/systemd/system/wireguard_reresolve-dns.service</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Unit]
Description=Reresolve DNS of all WireGuard endpoints
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
ExecStart=/bin/sh -c 'for i in /etc/wireguard/*.conf; do /usr/share/wireguard-tools/examples/reresolve-dns/reresolve-dns.sh "$i"; done'</pre>
<p>Afterwards <a title="Enable" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Enable">enable</a> and <a title="Start" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Start">start</a> <code>wireguard_reresolve-dns.timer</code>
</p>
<h3><span id="Generate_QR_code" class="mw-headline">Generate QR code</span></h3>
<p>If the client is a mobile device such as a phone, <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=qrencode" class="external text" rel="nofollow">qrencode</a></span> can be used to generate client's configuration QR code and display it in terminal:
</p>
<pre>$ qrencode -t ansiutf8 -r <i>client.conf</i>
</pre>
<h3><span id="Enable_debug_logs" class="mw-headline">Enable debug logs</span></h3>
<p>When using the Linux kernel module on a kernel that supports dynamic debugging, debugging information can be written into the kernel ring buffer (viewable with <a title="Dmesg" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Dmesg">dmesg</a> and <a title="Journalctl" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Journalctl">journalctl</a>) by running:
</p>
<pre># modprobe wireguard
# echo module wireguard +p &gt; /sys/kernel/debug/dynamic_debug/control
</pre>
<h3><span id="Reload_peer_.28server.29_configuration"></span><span id="Reload_peer_(server)_configuration" class="mw-headline">Reload peer (server) configuration</span></h3>
<p>In case the WireGuard peer (mostly server) adding or removing another peers from its configuration and wants to reload it without stopping any active sessions, one can execute the following command to do it:
</p>
<pre># wg syncconf ${WGNET} &lt;(wg-quick strip ${WGNET})
</pre>
<p>Where <code>$WGNET</code> is WireGuard interface name or configuration base name, for example <code>wg0</code> (for server) or <code>client</code> (without the <i>.conf</i> extension, for client).
</p>
<div class="noprint archwiki-template-message">
<p><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-view-fullscreen.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/3/38/Tango-view-fullscreen.png" alt="Tango-view-fullscreen.png"></a><b>This article or section needs expansion.</b><a class="image" href="https://wiki.archlinux.org/title/WireGuard/title/File:Tango-view-fullscreen.png"><img height="48" width="48" decoding="async" src="https://wiki.archlinux.org/images/3/38/Tango-view-fullscreen.png" alt="Tango-view-fullscreen.png"></a></p>
<div><b>Reason:</b> Show how to do this with other network managers from <a href="https://wiki.archlinux.org/title/WireGuard#Persistent_configuration">#Persistent configuration</a>. (Discuss in <a href="https://wiki.archlinux.org/title/Talk:WireGuard" class="external text" rel="nofollow">Talk:WireGuard</a>)</div>
</div>
<h2><span id="Troubleshooting" class="mw-headline">Troubleshooting</span></h2>
<h3><span id="Routes_are_periodically_reset" class="mw-headline">Routes are periodically reset</span></h3>
<p>Users of <a title="NetworkManager" href="https://wiki.archlinux.org/title/WireGuard/title/NetworkManager">NetworkManager</a> should make sure that it <a title="NetworkManager" href="https://wiki.archlinux.org/title/WireGuard/title/NetworkManager#Ignore_specific_devices">is not managing</a> the WireGuard interface(s). For example, create the following configuration file:
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/NetworkManager/conf.d/unmanaged.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[keyfile]
unmanaged-devices=type:wireguard</pre>
<h3><span id="Broken_DNS_resolution" class="mw-headline">Broken DNS resolution</span></h3>
<p>When tunneling all traffic through a WireGuard interface, the connection can become seemingly lost after a while or upon new connection. This could be caused by a <a title="Network manager" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Network_manager">network manager</a> or <a title="DHCP" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/DHCP">DHCP</a> client overwriting <code>/etc/resolv.conf</code>.
</p><p>By default <i>wg-quick</i>  uses <i>resolvconf</i> to register new <a title="DNS" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/DNS">DNS</a> entries (from the <code>DNS</code> keyword in the configuration file). This will cause issues with <a title="Network manager" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Network_manager">network managers</a> and <a title="DHCP" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/DHCP">DHCP</a> clients that do not use <i>resolvconf</i>, as they will overwrite <code>/etc/resolv.conf</code> thus removing the DNS servers added by wg-quick.
</p><p>The solution is to use networking software that supports <a title="Resolvconf" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Resolvconf">resolvconf</a>.
</p>
<div class="archwiki-template-box archwiki-template-box-note"><strong>Note:</strong> Users of <a title="Systemd-resolved" href="https://wiki.archlinux.org/title/WireGuard/title/Systemd-resolved">systemd-resolved</a> should make sure that <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=systemd-resolvconf" class="external text" rel="nofollow">systemd-resolvconf</a></span> is <a title="Install" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Install">installed</a>.</div>
<p>Users of <a title="NetworkManager" href="https://wiki.archlinux.org/title/WireGuard/title/NetworkManager">NetworkManager</a> should know that it does not use resolvconf by default.  It is recommended to use <a title="Systemd-resolved" href="https://wiki.archlinux.org/title/WireGuard/title/Systemd-resolved">systemd-resolved</a>.  If this is undesirable, <a title="Install" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Install">install</a> <span class="plainlinks archwiki-template-pkg"><a href="https://archlinux.org/packages/?name=openresolv" class="external text" rel="nofollow">openresolv</a></span> and configure NetworkManager to use it: <a title="NetworkManager" href="https://wiki.archlinux.org/title/WireGuard/title/NetworkManager#Use_openresolv">NetworkManager#Use openresolv</a>.
</p>
<h3><span id="Low_MTU" class="mw-headline">Low MTU</span></h3>
<p>Due to too low MTU (lower than 1280), wg-quick may have failed to create the WireGuard interface. This can be solved by setting the MTU value in WireGuard configuration in Interface section on client.
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">foo.config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[Interface]
Address = 10.200.200.2/24
MTU = 1420
PrivateKey = <i>PEER_FOO_PRIVATE_KEY</i>
DNS = 10.200.200.1</pre>
<h3><span id="Key_is_not_the_correct_length_or_format" class="mw-headline">Key is not the correct length or format</span></h3>
<p>To avoid the following error, put the key value in the configuration file and not the path to the key file.
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;"># wg-quick up wg0</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[#] ip link add wg0 type wireguard
[#] wg setconf wg0 /dev/fd/63
Key is not the correct length or format: `<i>/path/example.key'</i>
Configuration parsing error
[#] ip link delete dev wg0
</pre>
<h3><span id="Unable_to_establish_a_persistent_connection_behind_NAT_.2F_firewall"></span><span id="Unable_to_establish_a_persistent_connection_behind_NAT_/_firewall" class="mw-headline">Unable to establish a persistent connection behind NAT / firewall</span></h3>
<p>By default, WireGuard peers remain silent while they do not need to communicate, so peers located behind a NAT and/or <a title="Firewall" class="mw-redirect" href="https://wiki.archlinux.org/title/WireGuard/title/Firewall">firewall</a> may be unreachable from other peers until they reach out to other peers themselves (or the connection may time out). Adding <code>PersistentKeepalive = 25</code> to the <code>[Peer]</code> settings of a peer located behind a NAT and/or firewall can ensure that the connection remains open.
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;"># Set the persistent-keepalive via command line (temporarily)</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">[#] wg set wg0 peer $PUBKEY persistent-keepalive 25
</pre>
<h3><span id="Loop_routing" class="mw-headline">Loop routing</span></h3>
<p>Adding the endpoint IP to the allowed IPs list, the kernel will attempt to send handshakes to said device binding, rather than using the original route. This results in failed handshake attempts.
</p><p>As a workaround, the correct route to the endpoint needs to be manually added using
</p>
<pre>ip route add &lt;endpoint ip&gt; via &lt;gateway&gt; dev &lt;network interface&gt;
</pre>
<p>e.g. for peer B from above in a standard LAN setup:
</p>
<pre>ip route add 203.0.113.102 via 192.168.0.1 dev eth0
</pre>
<p>To make this route persistent, the command can be added as <code>PostUp = ip route ...</code> to the <code>[Interface]</code> section of <code>wg0.conf</code>. However, on certain setups (e.g. using <code>wg-quick@.service</code> in combination with NetworkManager) this might fail on resume. Furthermore, this only works for a static network setup and fails if gateways or devices change (e.g. using ethernet or wifi on a laptop).
</p><p>Using NetworkManager, a more flexible solution is to start WireGuard using a dispatcher script. As root, create
</p>
<pre data-darkreader-inline-border-bottom="" style="margin-bottom: 0px; border-bottom: none; padding-bottom: 0.8em; --darkreader-inline-border-bottom: initial;">/etc/NetworkManager/dispatcher.d/50-wg0.sh</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">#!/bin/sh
case $2 in
  up)
 &nbsp;  wg-quick up wg0
 &nbsp;  ip route add &lt;endpoint ip&gt; via $IP4_GATEWAY dev $DEVICE_IP_IFACE
 &nbsp; &nbsp;;;
  pre-down)
 &nbsp;  wg-quick down wg0
 &nbsp; &nbsp;;;
esac</pre>
<p>If not already running, start and enable <code>NetworkManager-dispatcher.service</code>.
Also, make sure that NetworkManager is not managing routes for <code>wg0</code> (<a href="https://wiki.archlinux.org/title/WireGuard#Routes_are_periodically_reset">see above</a>).</p></div></div></div>
